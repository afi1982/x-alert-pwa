// פונקציית החיפוש המעודכנת עבור Gemini
async function searchKeyword(kw) {
  const now = new Date();
  const prompt = `Search X (Twitter) for the latest posts about: "${kw.terms}". 
  ONLY posts from the LAST 2 MINUTES.
  Return JSON only: {"posts":[{"text":"tweet content","author":"@handle","time":"1m ago","url":"link"}]}`;

  try {
    const r = await fetch("/api/search", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt: prompt })
    });

    if (!r.ok) {
        const errData = await r.json();
        throw new Error(errData.error || `API ${r.status}`);
    }
    
    const data = await r.json();
    
    // חילוץ הטקסט מהמבנה של Gemini
    const aiResponseText = data.candidates[0].content.parts[0].text;
    const result = JSON.parse(aiResponseText);
    const posts = result.posts || [];

    if (posts.length === 0) return { posts: [], translated: [] };

    const translated = await translatePosts(posts);
    return { posts, translated };
    
  } catch (err) {
    console.error('Search error:', err);
    S.errors.push({ time: new Date().toISOString(), msg: err.message });
    render();
    return { posts: [], translated: [], error: err.message };
  }
}

// פונקציית התרגום המעודכנת
async function translatePosts(posts) {
  if (!posts.length) return [];
  const txt = posts.map((p, i) => `[${i + 1}] ${p.text}`).join('\n');
  
  try {
    const r = await fetch("/api/search", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        prompt: `Translate these tweets to Hebrew. Keep usernames as-is. 
        Return ONLY JSON format: {"translations":[{"index":1,"hebrew":"text"}]}
        
        Tweets:
        ${txt}`
      })
    });
    
    if (!r.ok) throw new Error('Translate fetch failed');
    
    const data = await r.json();
    const aiText = data.candidates[0].content.parts[0].text;
    const result = JSON.parse(aiText);
    
    return result.translations || [];
  } catch (e) {
    console.error('Translate error:', e);
    // במקרה של שגיאה, נחזיר את הטקסט המקורי כדי שהאפליקציה לא תקרוס
    return posts.map((p, i) => ({ index: i + 1, hebrew: p.text }));
  }
}
