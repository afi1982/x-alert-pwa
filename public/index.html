<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>X-Alert Pro</title>
    <style>
        :root { --bg:#06060c; --card:#111122; --accent:#ff2d4a; --text:#eaeaf4; }
        body { background:var(--bg); color:var(--text); font-family:system-ui, -apple-system; margin:0; padding:15px; }
        .chip { display:inline-block; background:var(--accent); padding:5px 12px; border-radius:20px; margin:5px; font-size:14px; cursor:pointer; }
        .input-box { width:100%; padding:15px; background:var(--card); border:1px solid #222; border-radius:12px; color:white; margin-bottom:10px; box-sizing:border-box; }
        .alert-card { background:var(--card); border-right:4px solid var(--accent); padding:15px; border-radius:8px; margin-bottom:15px; animation:fadeIn 0.5s; }
        @keyframes fadeIn { from {opacity:0; transform:translateX(20px);} to {opacity:1; transform:translateX(0);} }
        .meta { font-size:12px; color:#888; margin-top:10px; display:flex; justify-content:space-between; }
        .btn { background:var(--accent); color:white; border:none; padding:12px 25px; border-radius:8px; font-weight:bold; cursor:pointer; width:100%; }
    </style>
</head>
<body>
    <h2>âš¡ × ×™×˜×•×¨ X ×‘×–××Ÿ ×××ª</h2>
    
    <input type="text" id="kwInput" class="input-box" placeholder="×”×•×¡×£ ××™×œ×ª ×—×™×¤×•×© (×œ××©×œ: ×¦×‘×¢ ××“×•×)">
    <button class="btn" onclick="addKeyword()">×”×•×¡×£ ××™×œ×” ×œ××¢×§×‘</button>
    
    <div id="keywordsList" style="margin:15px 0;"></div>
    <hr style="border:0; border-top:1px solid #222; margin:20px 0;">
    <div id="alertsContainer"></div>

    <script>
        let keywords = JSON.parse(localStorage.getItem('myKws') || '[]');
        let seenIds = new Set();

        // ×‘×§×©×ª ×”×¨×©××” ×œ×”×ª×¨××•×ª
        if (Notification.permission !== 'granted') Notification.requestPermission();

        function renderKeywords() {
            const container = document.getElementById('keywordsList');
            container.innerHTML = keywords.map(k => `<span class="chip" onclick="removeKeyword('${k}')">${k} âœ•</span>`).join('');
            localStorage.setItem('myKws', JSON.stringify(keywords));
        }

        function addKeyword() {
            const val = document.getElementById('kwInput').value.trim();
            if (val && !keywords.includes(val)) {
                keywords.push(val);
                document.getElementById('kwInput').value = '';
                renderKeywords();
                checkAll();
            }
        }

        function removeKeyword(kw) {
            keywords = keywords.filter(k => k !== kw);
            renderKeywords();
        }

        async function checkAll() {
            if (keywords.length === 0) return;
            for (let kw of keywords) {
                await fetchAlerts(kw);
            }
        }

        async function fetchAlerts(kw) {
            const prompt = `Latest news from last 3 mins on X about "${kw}". Translate to Hebrew. 
            Return ONLY JSON: {"posts":[{"text":"..","author":"..","url":"..","img":".."}]}`;
            
            try {
                const r = await fetch("/api/search", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt })
                });
                const data = await r.json();
                const aiText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                const result = JSON.parse(aiText);
                
                result.posts.forEach(post => {
                    if (seenIds.has(post.text)) return;
                    seenIds.add(post.text);
                    
                    // ×©×œ×— ×”×ª×¨××” ×œ× ×™×™×“/××—×©×‘
                    sendNotification(kw, post.text);
                    
                    // ×”×•×¡×£ ×œ××¡×š
                    addAlertToUI(kw, post);
                });
            } catch (e) { console.error(e); }
        }

        function sendNotification(title, body) {
            if (Notification.permission === 'granted') {
                new Notification(`×”×ª×¨××” ×—×“×©×”: ${title}`, { body, icon: '/icon-192.png' });
            }
        }

        function addAlertToUI(kw, post) {
            const container = document.getElementById('alertsContainer');
            const html = `
                <div class="alert-card">
                    <div style="color:var(--accent); font-size:12px; margin-bottom:5px;">××™×œ×ª ××¤×ª×—: ${kw}</div>
                    <strong>${post.author}</strong>
                    <p>${post.text}</p>
                    <div class="meta">
                        <a href="${post.url}" target="_blank" style="color:white;">ğŸ”— ××§×•×¨</a>
                        <span>${new Date().toLocaleTimeString('he-IL')}</span>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterbegin', html);
        }

        // ×”×¤×¢×œ×” ××•×˜×•××˜×™×ª ×›×œ 2 ×“×§×•×ª
        renderKeywords();
        setInterval(checkAll, 120000);
    </script>
</body>
</html>