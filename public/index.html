<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#0b1120">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>X Live Alert â€” Intelligence Monitor</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/icon-192.png">
<link rel="apple-touch-icon" href="/icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg-primary:#0b1120;
  --bg-surface:#111a2e;
  --bg-card:#162036;
  --bg-card-alt:#1a2540;
  --bg-input:#0d1526;
  --border:#243049;
  --border-light:#2d3d5a;
  --text-primary:#e1e7ef;
  --text-secondary:#8b98ad;
  --text-muted:#5a6478;
  --accent-red:#e53e3e;
  --accent-red-dim:#9b2c2c;
  --accent-green:#38a169;
  --accent-blue:#3182ce;
  --accent-cyan:#0bc5ea;
  --accent-amber:#d69e2e;
  --accent-purple:#805ad5;
  --source-x:#1d9bf0;
  --source-tg:#0088cc;
  --source-google:#4285f4;
  --rel-high:#38a169;
  --rel-medium:#d69e2e;
  --rel-low:#e53e3e;
  --font-ui:'Noto Sans Hebrew','Inter',-apple-system,sans-serif;
  --font-mono:'Space Mono','Menlo',monospace;
  --radius:6px;
  --radius-sm:4px;
}
html{background:var(--bg-primary);color:var(--text-primary);font-family:var(--font-ui)}
body{min-height:100vh;min-height:100dvh;background:var(--bg-primary)}
input,button,select{font-family:inherit;border:none;outline:none}
button{cursor:pointer}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg-primary)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* ===== MODAL ===== */
#modal-overlay{position:fixed;inset:0;background:rgba(5,8,18,0.92);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(8px)}
#modal-overlay.hidden{display:none}
.modal-box{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);width:100%;max-width:440px;padding:32px 28px}
.modal-brand{text-align:center;margin-bottom:24px}
.modal-brand h1{font-size:20px;font-weight:600;color:var(--text-primary);letter-spacing:0.5px}
.modal-brand p{font-size:13px;color:var(--text-secondary);margin-top:4px}
.provider-tabs{display:flex;gap:2px;background:var(--bg-primary);border-radius:var(--radius-sm);padding:2px;margin-bottom:20px}
.provider-tab{flex:1;padding:10px 8px;text-align:center;font-size:13px;font-weight:500;background:transparent;color:var(--text-muted);border-radius:var(--radius-sm);transition:all 0.2s}
.provider-tab.active{background:var(--bg-card);color:var(--text-primary)}
.modal-field{margin-bottom:16px}
.modal-field label{display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;font-weight:500}
.key-input-wrap{position:relative;display:flex;align-items:center}
.key-input-wrap input{width:100%;padding:10px 40px 10px 12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-family:var(--font-mono);font-size:13px;direction:ltr;text-align:left}
.key-input-wrap input:focus{border-color:var(--accent-blue)}
.key-toggle{position:absolute;left:8px;background:none;color:var(--text-muted);font-size:16px;padding:4px}
.modal-link{font-size:12px;color:var(--accent-blue);text-decoration:none;display:inline-block;margin-bottom:16px}
.modal-link:hover{text-decoration:underline}
.modal-btn{width:100%;padding:11px;font-size:14px;font-weight:600;border-radius:var(--radius-sm);color:#fff;transition:all 0.2s}
.modal-btn.primary{background:var(--accent-blue)}
.modal-btn.primary:hover{background:#2b6cb0}
.modal-btn:disabled{opacity:0.5;cursor:not-allowed}
.modal-status{font-size:12px;margin-top:10px;text-align:center;min-height:18px}
.modal-status.error{color:var(--accent-red)}
.modal-status.success{color:var(--accent-green)}
.modal-persist{display:flex;align-items:center;gap:8px;margin-bottom:16px;font-size:12px;color:var(--text-secondary)}
.modal-persist input[type=checkbox]{accent-color:var(--accent-blue)}

/* ===== HEADER ===== */
header{background:var(--bg-surface);border-bottom:1px solid var(--border);padding:12px 16px;position:sticky;top:0;z-index:100}
.header-row{display:flex;align-items:center;justify-content:space-between;max-width:800px;margin:0 auto}
.header-left{display:flex;align-items:center;gap:10px}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--accent-red);animation:pulse-dot 2s infinite;flex-shrink:0}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:0.4}}
.header-title{font-size:15px;font-weight:700;letter-spacing:1px;color:var(--text-primary)}
.header-subtitle{font-size:10px;color:var(--text-muted);letter-spacing:0.5px;font-weight:400;margin-top:1px}
.header-stats{display:flex;align-items:center;gap:12px;font-family:var(--font-mono);font-size:11px;color:var(--text-secondary)}
.header-stats span{white-space:nowrap}
.stat-divider{width:1px;height:14px;background:var(--border)}
.header-btn{background:none;color:var(--text-muted);font-size:16px;padding:6px;border-radius:var(--radius-sm);transition:color 0.2s}
.header-btn:hover{color:var(--text-primary)}

/* ===== MAIN ===== */
main{max-width:800px;margin:0 auto;padding:12px 12px 100px}

/* ===== CONTROL PANEL ===== */
.panel{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.panel-title{font-size:12px;color:var(--text-muted);font-weight:600;letter-spacing:0.5px;margin-bottom:12px;text-transform:uppercase}
.add-row{display:flex;gap:8px;margin-bottom:12px}
.add-row input[type=text]{flex:1;padding:9px 12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:14px}
.add-row input[type=text]:focus{border-color:var(--accent-blue)}
.add-row select{padding:9px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-secondary);font-size:12px;font-family:var(--font-mono);min-width:70px}
.add-btn{padding:9px 16px;background:var(--accent-blue);color:#fff;font-size:13px;font-weight:600;border-radius:var(--radius-sm);white-space:nowrap;transition:background 0.2s}
.add-btn:hover{background:#2b6cb0}

/* ===== KEYWORDS ===== */
.kw-grid{display:flex;flex-wrap:wrap;gap:8px}
.kw-chip{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 10px;min-width:140px;position:relative;transition:border-color 0.3s}
.kw-chip.searching{border-color:var(--accent-cyan)}
.kw-chip.found{border-color:var(--accent-red)}
.kw-chip.paused{opacity:0.5}
.kw-top{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.kw-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;background:var(--accent-green)}
.kw-chip.searching .kw-dot{background:var(--accent-cyan);animation:pulse-dot 1s infinite}
.kw-chip.found .kw-dot{background:var(--accent-red)}
.kw-chip.paused .kw-dot{background:var(--text-muted)}
.kw-text{font-size:13px;font-weight:500;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:120px}
.kw-meta{display:flex;align-items:center;gap:8px;font-family:var(--font-mono);font-size:10px;color:var(--text-muted)}
.kw-actions{display:flex;gap:4px;margin-top:4px}
.kw-action{background:none;color:var(--text-muted);font-size:12px;padding:2px 4px;border-radius:2px;transition:color 0.2s}
.kw-action:hover{color:var(--text-primary)}
.kw-action.del:hover{color:var(--accent-red)}

/* ===== FILTER BAR ===== */
.filter-bar{display:flex;gap:4px;margin-bottom:12px;overflow-x:auto;padding-bottom:4px}
.filter-btn{padding:7px 14px;font-size:12px;font-weight:500;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-secondary);white-space:nowrap;transition:all 0.2s}
.filter-btn.active{background:var(--bg-card-alt);color:var(--text-primary);border-color:var(--border-light)}
.filter-count{font-family:var(--font-mono);font-size:10px;margin-right:4px;opacity:0.7}

/* ===== ALERT FEED ===== */
.feed-empty{text-align:center;padding:60px 20px;color:var(--text-muted)}
.feed-empty .fe-icon{font-size:32px;margin-bottom:12px;opacity:0.3}
.feed-empty p{font-size:14px}
.alert-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:8px;animation:card-in 0.3s ease;position:relative}
@keyframes card-in{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.alert-card.fresh{border-color:var(--accent-red-dim)}
.alert-card.fresh::before{content:'';position:absolute;inset:-1px;border-radius:var(--radius);border:1px solid var(--accent-red);opacity:0;animation:glow-fade 2s ease-out forwards}
@keyframes glow-fade{0%{opacity:0.8}100%{opacity:0}}
.alert-badges{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;align-items:center}
.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:3px;font-size:10px;font-weight:600;font-family:var(--font-mono);letter-spacing:0.3px}
.badge-new{background:var(--accent-red);color:#fff;animation:badge-flash 1s ease 2}
@keyframes badge-flash{0%,100%{opacity:1}50%{opacity:0.5}}
.badge-source{color:#fff}
.badge-source.x{background:var(--source-x)}
.badge-source.telegram{background:var(--source-tg)}
.badge-source.google{background:var(--source-google)}
.badge-lang{background:var(--bg-card-alt);color:var(--text-secondary);border:1px solid var(--border)}
.badge-rel{border:1px solid;font-size:9px}
.badge-rel.high{color:var(--rel-high);border-color:var(--rel-high)}
.badge-rel.medium{color:var(--rel-medium);border-color:var(--rel-medium)}
.badge-rel.low{color:var(--rel-low);border-color:var(--rel-low)}
.badge-kw{background:var(--accent-red-dim);color:var(--accent-red);font-size:10px}
.alert-text{font-size:14px;line-height:1.7;color:var(--text-primary);margin-bottom:10px;word-break:break-word}
.alert-text mark{background:rgba(229,62,62,0.2);color:var(--accent-red);padding:0 2px;border-radius:2px}
.alert-meta{display:flex;flex-wrap:wrap;align-items:center;gap:8px;font-size:12px;color:var(--text-muted);margin-bottom:6px}
.alert-meta a{color:var(--accent-blue);text-decoration:none;font-weight:500}
.alert-meta a:hover{text-decoration:underline}
.alert-original{margin-top:8px;border-top:1px solid var(--border);padding-top:8px}
.alert-orig-toggle{background:none;color:var(--text-muted);font-size:12px;display:flex;align-items:center;gap:4px;padding:2px 0}
.alert-orig-toggle:hover{color:var(--text-secondary)}
.alert-orig-text{font-size:13px;color:var(--text-secondary);line-height:1.6;margin-top:6px;direction:ltr;text-align:left;display:none;word-break:break-word}
.alert-orig-text.open{display:block}

/* ===== FEED CONTROLS ===== */
.feed-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.feed-title{font-size:12px;color:var(--text-muted);font-weight:600;letter-spacing:0.5px;text-transform:uppercase}
.feed-actions{display:flex;gap:8px}
.feed-action-btn{background:none;color:var(--text-muted);font-size:11px;padding:4px 8px;border-radius:var(--radius-sm);border:1px solid var(--border);transition:all 0.2s}
.feed-action-btn:hover{color:var(--text-primary);border-color:var(--border-light)}

/* ===== POPUP NOTIFICATION ===== */
#popup{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:999;background:var(--bg-card-alt);border:1px solid var(--accent-red-dim);border-radius:var(--radius);padding:12px 16px;max-width:380px;width:calc(100% - 32px);box-shadow:0 8px 24px rgba(0,0,0,0.4);transition:all 0.3s ease;opacity:0;pointer-events:none;translate:0 -10px}
#popup.show{opacity:1;pointer-events:auto;translate:0 0}
.popup-text{font-size:13px;color:var(--text-primary);line-height:1.5}
.popup-badge{display:inline-block;font-size:10px;font-weight:600;padding:1px 6px;border-radius:3px;margin-left:6px}

/* ===== SEARCH PROGRESS ===== */
.search-bar{height:2px;background:var(--bg-primary);overflow:hidden;border-radius:1px;margin-bottom:8px;opacity:0;transition:opacity 0.2s}
.search-bar.active{opacity:1}
.search-bar-inner{height:100%;width:30%;background:var(--accent-cyan);border-radius:1px;animation:sweep 1.2s infinite ease-in-out}
@keyframes sweep{0%{transform:translateX(-100%)}100%{transform:translateX(400%)}}

/* ===== INSTALL BANNER ===== */
#install-banner{display:none;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;margin-bottom:12px;align-items:center;justify-content:space-between}
#install-banner.show{display:flex}
.install-text{font-size:13px;color:var(--text-secondary)}
.install-btn{padding:7px 14px;font-size:12px;font-weight:600;background:var(--accent-blue);color:#fff;border-radius:var(--radius-sm)}
.install-dismiss{background:none;color:var(--text-muted);font-size:18px;padding:4px}

/* ===== RESPONSIVE ===== */
@media(max-width:480px){
  .header-stats{gap:6px;font-size:10px}
  .kw-chip{min-width:120px}
  .add-row{flex-wrap:wrap}
  .add-row input[type=text]{min-width:0}
}
</style>
</head>
<body>

<!-- ===== API KEY MODAL ===== -->
<div id="modal-overlay">
  <div class="modal-box">
    <div class="modal-brand">
      <h1>X LIVE ALERT</h1>
      <p>××¢×¨×›×ª ××•×“×™×¢×™×Ÿ ×‘×–××Ÿ ×××ª</p>
    </div>
    <div class="provider-tabs">
      <button class="provider-tab active" data-provider="anthropic" onclick="selectProvider('anthropic')">Anthropic Claude</button>
      <button class="provider-tab" data-provider="gemini" onclick="selectProvider('gemini')">Google Gemini</button>
    </div>
    <div class="modal-field">
      <label id="key-label">××¤×ª×— API ×©×œ Anthropic</label>
      <div class="key-input-wrap">
        <input type="password" id="key-input" placeholder="sk-ant-..." dir="ltr" autocomplete="off">
        <button class="key-toggle" onclick="toggleKeyVis()">ğŸ‘</button>
      </div>
    </div>
    <a class="modal-link" id="key-help-link" href="https://console.anthropic.com/" target="_blank" rel="noopener">â† ××™×š ××©×™×’×™× ××¤×ª×—?</a>
    <div class="modal-persist">
      <input type="checkbox" id="persist-check" checked>
      <label for="persist-check">×©××•×¨ ××¤×ª×— ×‘××›×©×™×¨ (localStorage)</label>
    </div>
    <button class="modal-btn primary" id="key-submit" onclick="submitKey()">×××ª ×•×”×ª×—×‘×¨</button>
    <div class="modal-status" id="key-status"></div>
  </div>
</div>

<!-- ===== HEADER ===== -->
<header>
  <div class="header-row">
    <div class="header-left">
      <div class="live-dot"></div>
      <div>
        <div class="header-title">X LIVE ALERT</div>
        <div class="header-subtitle">REAL-TIME INTELLIGENCE MONITORING</div>
      </div>
    </div>
    <div class="header-stats">
      <span id="stat-kw">0 ××™×œ×™×</span>
      <div class="stat-divider"></div>
      <span id="stat-alerts">0 ×”×ª×¨××•×ª</span>
      <div class="stat-divider"></div>
      <span id="stat-uptime">00:00:00</span>
      <button class="header-btn" onclick="showSettings()" title="×”×’×“×¨×•×ª">âš™</button>
    </div>
  </div>
</header>

<!-- ===== MAIN ===== -->
<main>

  <!-- Install Banner -->
  <div id="install-banner">
    <span class="install-text">×”×ª×§×Ÿ ×›××¤×œ×™×§×¦×™×” ×‘××›×©×™×¨</span>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="install-btn" onclick="installApp()">×”×ª×§×Ÿ</button>
      <button class="install-dismiss" onclick="dismissInstall()">Ã—</button>
    </div>
  </div>

  <!-- Search progress -->
  <div class="search-bar" id="search-bar"><div class="search-bar-inner"></div></div>

  <!-- Control Panel -->
  <div class="panel">
    <div class="panel-title">×”×•×¡×¤×ª ××™×œ×ª ×—×™×¤×•×©</div>
    <div class="add-row">
      <input type="text" id="kw-input" placeholder="×œ×“×•×’××”: Iran nuclear, Ø­Ø²Ø¨ Ø§Ù„Ù„Ù‡, drone attack..." dir="auto">
      <select id="kw-interval">
        <option value="30000">30 ×©× ×³</option>
        <option value="60000" selected>1 ×“×§×³</option>
        <option value="120000">2 ×“×§×³</option>
        <option value="300000">5 ×“×§×³</option>
      </select>
      <button class="add-btn" onclick="addKeyword()">+ ×”×•×¡×£</button>
    </div>
    <div class="kw-grid" id="kw-grid"></div>
  </div>

  <!-- Filter bar -->
  <div class="filter-bar" id="filter-bar">
    <button class="filter-btn active" data-source="all" onclick="setFilter('all')">×”×›×œ <span class="filter-count" id="fc-all">0</span></button>
    <button class="filter-btn" data-source="x" onclick="setFilter('x')">ğ• <span class="filter-count" id="fc-x">0</span></button>
    <button class="filter-btn" data-source="telegram" onclick="setFilter('telegram')">Telegram <span class="filter-count" id="fc-telegram">0</span></button>
    <button class="filter-btn" data-source="google" onclick="setFilter('google')">×—×“×©×•×ª <span class="filter-count" id="fc-google">0</span></button>
  </div>

  <!-- Feed -->
  <div class="feed-header">
    <span class="feed-title" id="feed-label">×¢×“×›×•× ×™× ××—×¨×•× ×™×</span>
    <div class="feed-actions">
      <button class="feed-action-btn" onclick="clearAlerts()">× ×§×” ×”×›×œ</button>
    </div>
  </div>
  <div id="feed">
    <div class="feed-empty">
      <div class="fe-icon">â—‰</div>
      <p>×”×•×¡×£ ××™×œ×•×ª ×—×™×¤×•×© ×›×“×™ ×œ×”×ª×—×™×œ × ×™×˜×•×¨</p>
    </div>
  </div>
</main>

<!-- ===== POPUP ===== -->
<div id="popup"><div class="popup-text" id="popup-text"></div></div>

<script>
/* ==========================================================================
   X LIVE ALERT V2 â€” INTELLIGENCE MONITORING SYSTEM
   ========================================================================== */

// ===== CONSTANTS =====
const STORAGE = {
  PROVIDER: 'xlive_provider',
  API_KEY: 'xlive_apikey',
  KEYWORDS: 'xlive_keywords',
  PERSIST: 'xlive_persist'
};

const ANTHROPIC_URL = 'https://api.anthropic.com/v1/messages';
const GEMINI_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

const SOURCE_LABELS = {
  x: 'ğ• X/Twitter',
  telegram: 'Telegram',
  google: 'Google News'
};

const RELIABILITY_LABELS = {
  high: '×××™×Ÿ',
  medium: '×‘×™× ×•× ×™',
  low: '×œ× ×××•××ª'
};

const MAX_ALERTS = 100;
const MAX_HASHES = 500;

// ===== STATE =====
const state = {
  provider: null,
  apiKey: null,
  keywords: [],
  alerts: [],
  seenHashes: new Set(),
  timers: {},
  activeSearches: 0,
  currentFilter: 'all',
  startTime: Date.now()
};

// ===== DOM =====
const $ = id => document.getElementById(id);

// ===== INIT =====
function init() {
  // Load persisted state
  const persist = localStorage.getItem(STORAGE.PERSIST) !== 'false';
  if (persist) {
    state.provider = localStorage.getItem(STORAGE.PROVIDER);
    state.apiKey = localStorage.getItem(STORAGE.API_KEY);
  }

  if (state.provider && state.apiKey) {
    hideModal();
    loadKeywords();
  }

  // Register service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  }

  // Request notification permission
  if ('Notification' in window && Notification.permission === 'default') {
    setTimeout(() => Notification.requestPermission(), 2000);
  }

  // PWA install prompt
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    window._installPrompt = e;
    $('install-banner').classList.add('show');
  });

  // Uptime clock
  setInterval(updateStats, 1000);

  // Enter key on keyword input
  $('kw-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') addKeyword();
  });
}

// ===== PROVIDER SELECTION =====
function selectProvider(p) {
  document.querySelectorAll('.provider-tab').forEach(t => t.classList.toggle('active', t.dataset.provider === p));
  state.provider = p;

  if (p === 'anthropic') {
    $('key-label').textContent = '××¤×ª×— API ×©×œ Anthropic';
    $('key-input').placeholder = 'sk-ant-...';
    $('key-help-link').href = 'https://console.anthropic.com/';
  } else {
    $('key-label').textContent = '××¤×ª×— API ×©×œ Google Gemini';
    $('key-input').placeholder = 'AIza...';
    $('key-help-link').href = 'https://aistudio.google.com/apikey';
  }
  $('key-input').value = '';
  $('key-status').textContent = '';
}

// ===== API KEY =====
function toggleKeyVis() {
  const inp = $('key-input');
  inp.type = inp.type === 'password' ? 'text' : 'password';
}

async function submitKey() {
  const key = $('key-input').value.trim();
  if (!key) { setKeyStatus('×”×–×Ÿ ××¤×ª×— API', 'error'); return; }

  const btn = $('key-submit');
  btn.disabled = true;
  btn.textContent = '××××ª...';
  setKeyStatus('', '');

  try {
    const valid = state.provider === 'anthropic'
      ? await validateAnthropic(key)
      : await validateGemini(key);

    if (valid) {
      state.apiKey = key;
      const persist = $('persist-check').checked;
      if (persist) {
        localStorage.setItem(STORAGE.PROVIDER, state.provider);
        localStorage.setItem(STORAGE.API_KEY, key);
        localStorage.setItem(STORAGE.PERSIST, 'true');
      } else {
        localStorage.removeItem(STORAGE.API_KEY);
        localStorage.setItem(STORAGE.PERSIST, 'false');
      }
      setKeyStatus('××¤×ª×— ×ª×§×™×Ÿ!', 'success');
      setTimeout(() => { hideModal(); loadKeywords(); }, 600);
    } else {
      setKeyStatus('××¤×ª×— ×œ× ×ª×§×™×Ÿ. ×‘×“×•×§ ×•× ×¡×” ×©×•×‘.', 'error');
    }
  } catch (err) {
    setKeyStatus('×©×’×™××ª ×¨×©×ª: ' + err.message, 'error');
  }

  btn.disabled = false;
  btn.textContent = '×××ª ×•×”×ª×—×‘×¨';
}

async function validateAnthropic(key) {
  const res = await fetch(ANTHROPIC_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': key,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 10, messages: [{ role: 'user', content: 'Say OK' }] })
  });
  return res.ok;
}

async function validateGemini(key) {
  const res = await fetch(GEMINI_BASE + '?key=' + encodeURIComponent(key), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{ role: 'user', parts: [{ text: 'Say OK' }] }],
      generationConfig: { maxOutputTokens: 10 }
    })
  });
  return res.ok;
}

function setKeyStatus(msg, cls) {
  const el = $('key-status');
  el.textContent = msg;
  el.className = 'modal-status' + (cls ? ' ' + cls : '');
}

function hideModal() { $('modal-overlay').classList.add('hidden'); }
function showSettings() {
  $('modal-overlay').classList.remove('hidden');
  if (state.apiKey) $('key-input').value = state.apiKey;
  if (state.provider) selectProvider(state.provider);
}

// ===== KEYWORDS =====
function loadKeywords() {
  try {
    const saved = JSON.parse(localStorage.getItem(STORAGE.KEYWORDS) || '[]');
    saved.forEach(kw => {
      state.keywords.push(kw);
      if (kw.active) startMonitoring(kw);
    });
    renderKeywords();
  } catch (e) {}
}

function saveKeywords() {
  const data = state.keywords.map(k => ({ id: k.id, text: k.text, interval: k.interval, active: k.active }));
  localStorage.setItem(STORAGE.KEYWORDS, JSON.stringify(data));
}

function addKeyword() {
  const text = $('kw-input').value.trim();
  if (!text) return;

  const interval = parseInt($('kw-interval').value);
  const kw = {
    id: 'kw_' + Date.now(),
    text,
    interval,
    active: true,
    count: 0,
    lastCheck: null,
    status: 'idle'
  };

  state.keywords.push(kw);
  saveKeywords();
  renderKeywords();
  startMonitoring(kw);

  $('kw-input').value = '';
  $('kw-input').focus();
  updateStats();

  // Immediate first search
  doSearch(kw);
}

function removeKeyword(id) {
  stopMonitoring(id);
  state.keywords = state.keywords.filter(k => k.id !== id);
  saveKeywords();
  renderKeywords();
  updateStats();
}

function toggleKeyword(id) {
  const kw = state.keywords.find(k => k.id === id);
  if (!kw) return;
  kw.active = !kw.active;
  if (kw.active) { startMonitoring(kw); } else { stopMonitoring(id); kw.status = 'idle'; }
  saveKeywords();
  renderKeywords();
}

function startMonitoring(kw) {
  stopMonitoring(kw.id);
  state.timers[kw.id] = setInterval(() => doSearch(kw), kw.interval);
}

function stopMonitoring(id) {
  if (state.timers[id]) { clearInterval(state.timers[id]); delete state.timers[id]; }
}

function renderKeywords() {
  const grid = $('kw-grid');
  if (state.keywords.length === 0) { grid.innerHTML = ''; return; }

  grid.innerHTML = state.keywords.map(kw => {
    const cls = !kw.active ? 'paused' : kw.status === 'searching' ? 'searching' : kw.status === 'found' ? 'found' : '';
    const intervalLabel = kw.interval < 60000 ? (kw.interval / 1000) + 's' : (kw.interval / 60000) + 'm';
    const lastTime = kw.lastCheck ? new Date(kw.lastCheck).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '--:--:--';
    return `<div class="kw-chip ${cls}">
      <div class="kw-top">
        <div class="kw-dot"></div>
        <span class="kw-text" title="${esc(kw.text)}">${esc(kw.text)}</span>
      </div>
      <div class="kw-meta">
        <span>${intervalLabel}</span>
        <span>#${kw.count || 0}</span>
        <span>${lastTime}</span>
      </div>
      <div class="kw-actions">
        <button class="kw-action" onclick="toggleKeyword('${kw.id}')" title="${kw.active ? '×”×©×”×”' : '×”×¤×¢×œ'}">${kw.active ? 'â¸' : 'â–¶'}</button>
        <button class="kw-action del" onclick="removeKeyword('${kw.id}')" title="××—×§">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

// ===== SEARCH ENGINE =====
async function doSearch(kw) {
  if (!state.apiKey || kw.status === 'searching') return;

  kw.status = 'searching';
  kw.count = (kw.count || 0) + 1;
  kw.lastCheck = Date.now();
  state.activeSearches++;
  updateSearchBar();
  renderKeywords();

  try {
    const results = state.provider === 'anthropic'
      ? await searchAnthropic(kw.text)
      : await searchGemini(kw.text);

    processResults(results, kw);
  } catch (err) {
    console.error('Search error:', err);
  }

  kw.status = 'idle';
  state.activeSearches--;
  updateSearchBar();
  renderKeywords();
}

function buildPrompt(keyword) {
  const now = new Date().toISOString();
  return `You are a STRICT real-time news intelligence analyst. Your task is to find the MOST RECENT posts/news about: "${keyword}"

ABSOLUTE RULES:
1. ONLY report results that ACTUALLY APPEARED in your web search results. NEVER fabricate, guess, or hallucinate any result.
2. Every result MUST have a REAL URL that you found in the search results. NEVER construct or guess URLs.
3. If you find NO results from the last 1 minute, return {"results":[],"found":false,"searched_queries":[]}. This is the CORRECT response. Empty results are EXPECTED and PREFERRED over fabricated ones.
4. If you are uncertain about ANY detail (time, URL, author), SKIP that result entirely.

SEARCH STRATEGY â€” Execute these searches:
1. Web search: "${keyword}"
2. X/Twitter: "${keyword} site:x.com OR site:twitter.com"
3. Telegram: "${keyword} site:t.me"
4. Arabic translation search: search the Arabic translation of "${keyword}"
5. Persian/Farsi translation search: search the Persian translation of "${keyword}"
6. Arabic + X: Arabic translation of "${keyword}" + "site:x.com"
7. Persian + Telegram: Persian translation of "${keyword}" + "site:t.me"

KNOWN PERSIAN/ARABIC NEWS TELEGRAM CHANNELS to check:
- Search: "${keyword} telegram channel" in Arabic/Persian
- Major channels: Look for results from t.me domains in Persian and Arabic

TIME FILTER (EXTREMELY STRICT):
- Current UTC time: ${now}
- ONLY include results from the LAST 2 MINUTES (120 seconds)
- Acceptable timestamps: "just now", "1m", "2m", "seconds ago", "Ù„Ø­Ø¸Ø§ØªÛŒ Ù¾ÛŒØ´", "Ø§Ù„Ø¢Ù†", "Ù‚Ø¨Ù„ Ø¯Ù‚ÙŠÙ‚Ø©"
- REJECT: "3m", "5m", "10m", "1h", "2h" or anything older
- If timestamp is unclear or missing, DO NOT include the result

SOURCE RELIABILITY â€” Rate each source:
- "high": Verified accounts (âœ“), major outlets (Reuters, AP, BBC, Al Jazeera, CNN, Fars News, IRNA, Al Arabiya, Sky News Arabia), official government accounts, accounts with verified badges
- "medium": Known journalists, channels with established history, regional news sites
- "low": Anonymous accounts, new accounts, unverified sources, personal blogs

TRANSLATION:
- Translate ALL result text to Hebrew accurately
- Keep @handles, #hashtags, URLs, channel names, and numbers unchanged
- Preserve the meaning and tone faithfully

RESPONSE â€” Return ONLY valid JSON, no markdown, no explanation:
{
  "results": [
    {
      "text": "exact original text as found",
      "hebrew": "accurate Hebrew translation",
      "author": "@handle or channel name",
      "time": "relative time as displayed",
      "url": "exact URL from search results",
      "source": "x" or "telegram" or "google",
      "language": "en" or "ar" or "fa",
      "reliability": "high" or "medium" or "low"
    }
  ],
  "searched_queries": ["list every query you actually searched"],
  "found": true or false
}

REMEMBER: An empty results array is the CORRECT answer when nothing recent exists. NEVER invent results.`;
}

async function searchAnthropic(keyword) {
  const res = await fetch(ANTHROPIC_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': state.apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 4000,
      tools: [{ type: 'web_search_20250305', name: 'web_search', max_uses: 10 }],
      messages: [{ role: 'user', content: buildPrompt(keyword) }]
    })
  });

  if (!res.ok) throw new Error('Anthropic API ' + res.status);
  const data = await res.json();

  // Extract the final text block
  let text = '';
  if (data.content) {
    for (let i = data.content.length - 1; i >= 0; i--) {
      if (data.content[i].type === 'text' && data.content[i].text) {
        text = data.content[i].text;
        break;
      }
    }
  }
  return parseJsonResponse(text);
}

async function searchGemini(keyword) {
  const res = await fetch(GEMINI_BASE + '?key=' + encodeURIComponent(state.apiKey), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{ role: 'user', parts: [{ text: buildPrompt(keyword) }] }],
      tools: [{ google_search: {} }],
      generationConfig: { maxOutputTokens: 4000 }
    })
  });

  if (!res.ok) throw new Error('Gemini API ' + res.status);
  const data = await res.json();

  let text = '';
  try {
    text = data.candidates[0].content.parts.map(p => p.text || '').join('');
  } catch (e) {}
  return parseJsonResponse(text);
}

function parseJsonResponse(text) {
  if (!text) return { results: [], found: false, searched_queries: [] };

  // Try to extract JSON from the response
  let jsonStr = text;

  // Remove markdown code fences if present
  const fenceMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
  if (fenceMatch) jsonStr = fenceMatch[1];

  // Try to find JSON object
  const braceStart = jsonStr.indexOf('{');
  const braceEnd = jsonStr.lastIndexOf('}');
  if (braceStart !== -1 && braceEnd !== -1) {
    jsonStr = jsonStr.slice(braceStart, braceEnd + 1);
  }

  try {
    const parsed = JSON.parse(jsonStr);
    return {
      results: Array.isArray(parsed.results) ? parsed.results : [],
      found: !!parsed.found,
      searched_queries: parsed.searched_queries || []
    };
  } catch (e) {
    console.warn('JSON parse failed:', e);
    return { results: [], found: false, searched_queries: [] };
  }
}

// ===== RESULT PROCESSING =====
function processResults(data, kw) {
  if (!data.results || data.results.length === 0) return;

  let newCount = 0;
  const now = Date.now();

  for (const r of data.results) {
    // Validate: must have hebrew text and url
    if (!r.hebrew || !r.url) continue;

    // Validate URL looks real (basic check)
    if (!r.url.startsWith('http://') && !r.url.startsWith('https://')) continue;

    // Dedup via text hash
    const hash = hashText((r.text || '') + r.url);
    if (state.seenHashes.has(hash)) continue;
    state.seenHashes.add(hash);

    // Trim hash set
    if (state.seenHashes.size > MAX_HASHES) {
      const arr = [...state.seenHashes];
      state.seenHashes = new Set(arr.slice(arr.length - MAX_HASHES));
    }

    const alert = {
      id: 'a_' + now + '_' + newCount,
      keyword: kw.text,
      text: r.text || '',
      hebrew: r.hebrew,
      author: r.author || '',
      time: r.time || '',
      url: r.url,
      source: ['x', 'telegram', 'google'].includes(r.source) ? r.source : 'google',
      language: ['en', 'ar', 'fa'].includes(r.language) ? r.language : 'en',
      reliability: ['high', 'medium', 'low'].includes(r.reliability) ? r.reliability : 'low',
      detectedAt: now,
      fresh: true
    };

    state.alerts.unshift(alert);
    newCount++;

    // Notify
    notify(alert);
    showPopup(alert);
  }

  // Trim alerts
  if (state.alerts.length > MAX_ALERTS) {
    state.alerts = state.alerts.slice(0, MAX_ALERTS);
  }

  if (newCount > 0) {
    kw.status = 'found';
    renderKeywords();
    setTimeout(() => { kw.status = 'idle'; renderKeywords(); }, 3000);
  }

  renderAlerts();
  updateStats();
  updateFilterCounts();
}

function hashText(text) {
  let hash = 0;
  for (let i = 0; i < text.length; i++) {
    const c = text.charCodeAt(i);
    hash = ((hash << 5) - hash) + c;
    hash |= 0;
  }
  return 'h' + hash;
}

// ===== ALERT RENDERING =====
function renderAlerts() {
  const feed = $('feed');
  const filtered = state.currentFilter === 'all'
    ? state.alerts
    : state.alerts.filter(a => a.source === state.currentFilter);

  if (filtered.length === 0) {
    feed.innerHTML = `<div class="feed-empty"><div class="fe-icon">â—‰</div><p>${state.keywords.length ? '××™×Ÿ ×ª×•×¦××•×ª ×¢×“×™×™×Ÿ... ×××©×™×š ×œ×¡×¨×•×§' : '×”×•×¡×£ ××™×œ×•×ª ×—×™×¤×•×© ×›×“×™ ×œ×”×ª×—×™×œ × ×™×˜×•×¨'}</p></div>`;
    return;
  }

  const now = Date.now();
  feed.innerHTML = filtered.map(a => {
    const isFresh = (now - a.detectedAt) < 30000;
    const hebrewHighlighted = highlightKeyword(a.hebrew, a.keyword);
    const sourceBadgeCls = a.source;
    const relCls = a.reliability;

    return `<div class="alert-card${isFresh ? ' fresh' : ''}">
      <div class="alert-badges">
        ${isFresh ? '<span class="badge badge-new">NEW</span>' : ''}
        <span class="badge badge-source ${sourceBadgeCls}">${SOURCE_LABELS[a.source] || a.source}</span>
        <span class="badge badge-lang">${a.language.toUpperCase()}</span>
        <span class="badge badge-rel ${relCls}">${RELIABILITY_LABELS[a.reliability] || a.reliability}</span>
        <span class="badge badge-kw">${esc(a.keyword)}</span>
      </div>
      <div class="alert-text">${hebrewHighlighted}</div>
      <div class="alert-meta">
        <span>${esc(a.author)}</span>
        <span>Â·</span>
        <span>${esc(a.time)}</span>
        <span>Â·</span>
        <a href="${esc(a.url)}" target="_blank" rel="noopener">â†’ ×¦×¤×” ×‘××§×•×¨</a>
      </div>
      <div class="alert-original">
        <button class="alert-orig-toggle" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('span').textContent=this.nextElementSibling.classList.contains('open')?'â–²':'â–¼'">
          <span>â–¼</span> ×˜×§×¡×˜ ××§×•×¨×™ (${a.language.toUpperCase()})
        </button>
        <div class="alert-orig-text">${esc(a.text)}</div>
      </div>
    </div>`;
  }).join('');

  // Remove fresh flag after 30s
  setTimeout(() => {
    state.alerts.forEach(a => a.fresh = false);
  }, 30000);
}

function highlightKeyword(text, keyword) {
  if (!keyword || !text) return esc(text);
  const escaped = esc(text);
  const kw = esc(keyword);
  // Simple case-insensitive highlight
  try {
    const re = new RegExp('(' + kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
    return escaped.replace(re, '<mark>$1</mark>');
  } catch {
    return escaped;
  }
}

function clearAlerts() {
  state.alerts = [];
  state.seenHashes.clear();
  renderAlerts();
  updateStats();
  updateFilterCounts();
}

// ===== FILTERS =====
function setFilter(source) {
  state.currentFilter = source;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.source === source));
  renderAlerts();
}

function updateFilterCounts() {
  $('fc-all').textContent = state.alerts.length;
  $('fc-x').textContent = state.alerts.filter(a => a.source === 'x').length;
  $('fc-telegram').textContent = state.alerts.filter(a => a.source === 'telegram').length;
  $('fc-google').textContent = state.alerts.filter(a => a.source === 'google').length;
}

// ===== NOTIFICATIONS =====
function notify(alert) {
  // Browser notification
  if ('Notification' in window && Notification.permission === 'granted') {
    try {
      const n = new Notification('X Live Alert â€” ' + alert.keyword, {
        body: alert.hebrew.slice(0, 120),
        icon: '/icon-192.png',
        tag: alert.id,
        renotify: true,
        vibrate: [200, 100, 200, 100, 200]
      });
      n.onclick = () => { window.focus(); n.close(); };
    } catch (e) {
      // Fallback to SW notification
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
          type: 'notify',
          title: 'X Live Alert â€” ' + alert.keyword,
          body: alert.hebrew.slice(0, 120),
          tag: alert.id,
          url: alert.url
        });
      }
    }
  }

  // Sound
  playAlertSound();

  // Vibration
  if (navigator.vibrate) {
    navigator.vibrate([200, 100, 200, 100, 200]);
  }
}

function showPopup(alert) {
  const el = $('popup');
  const sourceLabel = SOURCE_LABELS[alert.source] || alert.source;
  $('popup-text').innerHTML = `<span class="popup-badge" style="background:var(--source-${alert.source === 'x' ? 'x' : alert.source === 'telegram' ? 'tg' : 'google'})">${esc(sourceLabel)}</span> ${esc(alert.hebrew.slice(0, 100))}`;
  el.classList.add('show');
  clearTimeout(window._popupTimer);
  window._popupTimer = setTimeout(() => el.classList.remove('show'), 5000);
}

function playAlertSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const freqs = [880, 0, 880, 0, 1100];
    const durations = [0.1, 0.05, 0.1, 0.05, 0.15];
    let t = ctx.currentTime;

    for (let i = 0; i < freqs.length; i++) {
      if (freqs[i] > 0) {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freqs[i];
        gain.gain.value = 0.12;
        gain.gain.exponentialRampToValueAtTime(0.001, t + durations[i]);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(t);
        osc.stop(t + durations[i]);
      }
      t += durations[i];
    }
    setTimeout(() => ctx.close(), 1000);
  } catch (e) {}
}

// ===== SEARCH BAR =====
function updateSearchBar() {
  $('search-bar').classList.toggle('active', state.activeSearches > 0);
}

// ===== STATS =====
function updateStats() {
  const active = state.keywords.filter(k => k.active).length;
  $('stat-kw').textContent = active + ' ××™×œ×™×';
  $('stat-alerts').textContent = state.alerts.length + ' ×”×ª×¨××•×ª';

  const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
  const h = String(Math.floor(elapsed / 3600)).padStart(2, '0');
  const m = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
  const s = String(elapsed % 60).padStart(2, '0');
  $('stat-uptime').textContent = h + ':' + m + ':' + s;
}

// ===== PWA INSTALL =====
function installApp() {
  if (window._installPrompt) {
    window._installPrompt.prompt();
    window._installPrompt.userChoice.then(() => { $('install-banner').classList.remove('show'); });
  }
}
function dismissInstall() { $('install-banner').classList.remove('show'); }

// ===== UTILITIES =====
function esc(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// ===== START =====
init();
</script>
</body>
</html>
